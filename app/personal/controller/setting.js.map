{
    "version": 3,
    "sources": [
        "..\\..\\..\\src\\personal\\controller\\setting.js"
    ],
    "names": [
        "initPage",
        "page",
        "session",
        "uinfo",
        "think",
        "isEmpty",
        "name",
        "model",
        "findUser",
        "userinfo",
        "assign",
        "displayView",
        "redirect",
        "checkIsExist",
        "where",
        "rs",
        "s",
        "length",
        "indexAction",
        "savebaseAction",
        "newData",
        "post",
        "nickname",
        "email",
        "sign",
        "findOne",
        "console",
        "log",
        "json",
        "status",
        "errno",
        "errmsg",
        "userFlag",
        "emailFlag",
        "saveUserInfo",
        "success",
        "resetpwdAction",
        "password",
        "md5",
        "way",
        "oldpassword",
        "resetpicAction",
        "pic",
        "checkemailAction",
        "findAll",
        "passwordAction",
        "picAction"
    ],
    "mappings": "AAAA;;;;;;;;;;;;;;;;;;;;;;;;AAEA;;;;;;;;;;;;;;AAEE;;;;AAIA;mBACMA,Q;2FAASC,I;;;;;;;qBACG,KAAKC,OAAL,CAAa,OAAb,C;;;AAAZC,mB;;kBACAC,MAAMC,OAAN,CAAcF,KAAd,C;;;;;mBACCA,MAAMG,I;;;;;;qBACY,KAAKC,KAAL,CAAW,UAAX,EAAuBC,QAAvB,CAAgC,EAACF,MAAKH,MAAMG,IAAZ,EAAhC,C;;;AAAfG,sB;;AACJ,mBAAKC,MAAL,CAAY,UAAZ,EAAuBD,SAAS,CAAT,CAAvB;+CACO,KAAKE,WAAL,CAAiB,aAAWV,IAA5B,C;;;+CAEA,KAAKU,WAAL,CAAiB,qBAAjB,C;;;;;;;+CAGF,KAAKC,QAAL,CAAc,aAAd,C;;;;;;;;;;;;;;;;AAGX;;;mBACMC,Y;6FAAaC,K;;;;;;;qBACD,KAAKP,KAAL,CAAW,UAAX,EAAuBC,QAAvB,CAAgCM,KAAhC,C;;;AAAVC,gB;AACAC,e,GAAGD,GAAGE,MAAH,GAAU,CAAX,GAAc,CAAd,GAAgB,C;gDACfD,C;;;;;;;;;;;;;;;;AAEX;;;mBACME,W;;;;;;AACJ,mBAAKR,MAAL,CAAY,OAAZ,EAAoB,gBAApB;AACA,mBAAKA,MAAL,CAAY,KAAZ,EAAkB,UAAlB;AACA,mBAAKV,QAAL,CAAc,OAAd;;;;;;;;;;;;;;;;AAEF;;;mBACMmB,c;;;;;;;;qBACY,KAAKjB,OAAL,CAAa,OAAb,C;;;AAAZC,mB;AACAiB,qB,GAAQ,KAAKC,IAAL,E;AACRf,kB,GAAKc,QAAQd,I;AACbgB,sB,GAASF,QAAQE,Q;AACjBC,mB,GAAMH,QAAQG,K;AACdC,kB,GAAKJ,QAAQI,I;;qBACE,KAAKjB,KAAL,CAAW,UAAX,EAAuBkB,OAAvB,CAA+B,MAA/B,EAAsC,EAACnB,MAAKH,MAAMG,IAAZ,EAAtC,C;;;AAAfG,sB;;AACJiB,sBAAQC,GAAR,CAAYlB,QAAZ;;oBAEGH,SAAO,EAAP,IAAWgB,aAAW,EAAtB,IAA0BC,UAAQ,E;;;;;oBAChCd,SAASc,KAAT,KAAiBA,KAAjB,IAAwBd,SAASa,QAAT,KAAoBA,QAA5C,IAAwDb,SAASe,IAAT,KAAgBA,I;;;;;gDAEhE,KAAKI,IAAL,CAAU,EAACC,QAAO,CAAR,EAAUC,OAAM,CAAhB,EAAkBC,QAAO,sCAAzB,EAAV,C;;;;qBAEY,KAAKlB,YAAL,CAAkB,EAACP,MAAKA,IAAN,EAAlB,C;;;AAAf0B,sB;;qBACgB,KAAKnB,YAAL,CAAkB,EAACU,OAAMA,KAAP,EAAlB,C;;;AAAhBU,uB;;oBACDD,aAAW,CAAX,IAAc7B,MAAMG,IAAN,KAAaA,I;;;;;gDACrB,KAAKsB,IAAL,CAAU,EAACC,QAAO,CAAR,EAAUC,OAAM,CAAhB,EAAkBC,QAAO,sBAAzB,EAAV,C;;;oBACAE,cAAY,CAAZ,IAAexB,SAASc,KAAT,KAAiBA,K;;;;;gDAChC,KAAKK,IAAL,CAAU,EAACC,QAAO,CAAR,EAAUC,OAAM,CAAhB,EAAkBC,QAAO,mBAAzB,EAAV,C;;;;qBAEM,KAAKxB,KAAL,CAAW,UAAX,EAAuB2B,YAAvB,CAAoCd,OAApC,EAA4C,EAACd,MAAKc,QAAQd,IAAd,EAA5C,C;;;AAATS,gB;;mBACDA,E;;;;;gDAAW,KAAKoB,OAAL,E;;;;;;;;;;;;;;;;AAKxB;;;mBACMC,c;;;;;;;;qBACY,KAAKlC,OAAL,CAAa,OAAb,C;;;AAAZC,mB;AACAiB,qB,GAAQ,KAAKC,IAAL,E;;AACRD,sBAAQiB,QAAR,GAAiBjC,MAAMkC,GAAN,CAAUlB,QAAQiB,QAAlB,CAAjB;AACAjB,sBAAQmB,GAAR,GAAY,MAAZ;AACAC,yB,GAAYpC,MAAMkC,GAAN,CAAUlB,QAAQoB,WAAlB,C;AACZH,sB,GAASjB,QAAQiB,Q;;oBAElBG,gBAAc,E;;;;;;qBAEI,KAAKjC,KAAL,CAAW,UAAX,EAAuBC,QAAvB,CAAgC,EAACF,MAAKH,MAAMG,IAAZ,EAAhC,C;;;AAAfG,sB;;kBACAL,MAAMC,OAAN,CAAcI,SAAS,CAAT,EAAY4B,QAA1B,C;;;;;oBAEDG,gBAAc/B,SAAS,CAAT,EAAY4B,Q;;;;;gDACpB,KAAKT,IAAL,CAAU,EAACC,QAAO,CAAR,EAAUC,OAAM,CAAhB,EAAkBC,QAAO,yBAAzB,EAAV,C;;;oBAGNM,aAAW,E;;;;;;qBACC,KAAK9B,KAAL,CAAW,UAAX,EAAuB2B,YAAvB,CAAoCd,OAApC,EAA4C,EAACd,MAAKH,MAAMG,IAAZ,EAA5C,C;;;AAATS,gB;;mBACDA,E;;;;;gDAAW,KAAKoB,OAAL,E;;;;;;;;;;;;;;;;AAIpB;;;mBACMM,c;;;;;;;;qBACY,KAAKvC,OAAL,CAAa,OAAb,C;;;AAAZC,mB;AACAiB,qB,GAAQ,KAAKC,IAAL,E;AACRqB,iB,GAAItB,QAAQsB,G;;oBAEbA,QAAM,E;;;;;;qBACQ,KAAKnC,KAAL,CAAW,UAAX,EAAuB2B,YAAvB,CAAoCd,OAApC,EAA4C,EAACd,MAAKH,MAAMG,IAAZ,EAA5C,C;;;AAATS,gB;;mBACDA,E;;;;;gDAAW,KAAKoB,OAAL,E;;;;;;;;;;;;;;;;AAGpB;;;mBACMQ,gB;;;;;;;;qBACY,KAAKtB,IAAL,CAAU,OAAV,C;;;AAAZE,mB;;qBACU,KAAKhB,KAAL,CAAW,UAAX,EAAuBqC,OAAvB,CAA+B,MAA/B,EAAsC,EAAC,SAAQrB,KAAT,EAAtC,C;;;AAAVR,gB;;oBACDA,GAAGE,MAAH,GAAU,C;;;;;gDACJ,KAAKW,IAAL,CAAU,EAACC,QAAO,CAAR,EAAUC,OAAM,CAAhB,EAAkBC,QAAO,mBAAzB,EAAV,C;;;gDAEA,KAAKH,IAAL,CAAU,EAACC,QAAO,CAAR,EAAUC,OAAM,CAAhB,EAAkBC,QAAO,eAAzB,EAAV,C;;;;;;;;;;;;;;;;;mBAGLc,c;;;;;;AACJ,mBAAKnC,MAAL,CAAY,OAAZ,EAAoB,cAApB;AACA,mBAAKA,MAAL,CAAY,KAAZ,EAAkB,UAAlB;AACA,mBAAKV,QAAL,CAAc,UAAd;;;;;;;;;;;;;;;;;mBAEI8C,S;;;;;;AACJ,mBAAKpC,MAAL,CAAY,OAAZ,EAAoB,cAApB;AACA,mBAAKA,MAAL,CAAY,KAAZ,EAAkB,SAAlB;AACA,mBAAKV,QAAL,CAAc,KAAd",
    "file": "..\\..\\..\\src\\personal\\controller\\setting.js",
    "sourcesContent": [
        "'use strict';\r\n\r\nimport Base from './base.js';\r\nexport default class extends Base {\r\n  /**\r\n   * index action\r\n   * @return {Promise} []\r\n   */\r\n  //页面初始化数据\r\n  async initPage(page){\r\n    let uinfo=await this.session('uInfo');\r\n    if(!think.isEmpty(uinfo)){\r\n      if(uinfo.name){\r\n        let userinfo=await this.model('personal').findUser({name:uinfo.name});\r\n        this.assign(\"userinfo\",userinfo[0]);\r\n        return this.displayView(\"setting_\"+page);\r\n      }else{\r\n        return this.displayView(\"../common/error_404\");\r\n      }\r\n    }else {\r\n      return this.redirect('/login.html');\r\n    }\r\n  }\r\n  //检查是否存在\r\n  async checkIsExist(where){\r\n      let rs= await this.model('personal').findUser(where);\r\n      let s=(rs.length>0)?0:1;\r\n      return s;\r\n  }\r\n  // 基础信息设置\r\n  async indexAction(){\r\n    this.assign(\"title\",\"Cài đặt cơ bản\");\r\n    this.assign(\"tab\",\"userinfo\");\r\n    this.initPage(\"index\");\r\n  }\r\n  // 保存基础信息\r\n  async savebaseAction(){\r\n    let uinfo=await this.session('uInfo');\r\n    let newData=this.post();\r\n    let name=newData.name;\r\n    let nickname=newData.nickname;\r\n    let email=newData.email;\r\n    let sign=newData.sign;\r\n    let userinfo=await this.model(\"personal\").findOne('user',{name:uinfo.name});\r\n    console.log(userinfo);\r\n\r\n    if(name!==''&&nickname!==''&&email!==''){\r\n      if(userinfo.email===email&&userinfo.nickname===nickname && userinfo.sign===sign){\r\n        //邮箱和昵称都未改变\r\n          return this.json({status:0,errno:1,errmsg:'Vui lòng đổi thông tin cần cập nhật!'});\r\n      }else{\r\n          let userFlag=await this.checkIsExist({name:name});\r\n          let emailFlag=await this.checkIsExist({email:email});\r\n          if(userFlag===0&&uinfo.name!==name){\r\n            return this.json({status:0,errno:1,errmsg:'Tài khoản đã tồn tại'});\r\n          }else if(emailFlag===0&&userinfo.email!==email){\r\n            return this.json({status:0,errno:1,errmsg:'Email đã tồn tại!'});\r\n          }else {\r\n            let rs=await this.model('personal').saveUserInfo(newData,{name:newData.name});\r\n            if(rs) return this.success();\r\n          }\r\n      }\r\n    }\r\n  }\r\n  // 重置密码\r\n  async resetpwdAction(){\r\n    let uinfo=await this.session('uInfo');\r\n    let newData=this.post();\r\n        newData.password=think.md5(newData.password);\r\n        newData.way='site';\r\n    let oldpassword=think.md5(newData.oldpassword);\r\n    let password=newData.password;\r\n\r\n    if(oldpassword!==''){\r\n      //验证原始密码是否正确\r\n      let userinfo=await this.model('personal').findUser({name:uinfo.name});\r\n      if(!think.isEmpty(userinfo[0].password))\n      {\r\n      if(oldpassword!==userinfo[0].password){\r\n        return this.json({status:0,errno:1,errmsg:'Mật khẩu cũ không đúng！'});\r\n      }\n    }\r\n      if(password!==''){\r\n        let rs=await this.model('personal').saveUserInfo(newData,{name:uinfo.name});\r\n        if(rs) return this.success();\r\n      }\r\n    }\r\n  }\r\n  // 重置头像\r\n  async resetpicAction(){\r\n    let uinfo=await this.session('uInfo');\r\n    let newData=this.post();\r\n    let pic=newData.pic;\r\n\r\n    if(pic!==''){\r\n        let rs=await this.model('personal').saveUserInfo(newData,{name:uinfo.name});\r\n        if(rs) return this.success();\r\n    }\r\n  }\r\n  //校验邮箱是否存在\r\n  async checkemailAction(){\r\n    let email=await this.post('email');\r\n    let rs= await this.model('personal').findAll('user',{'email':email});\r\n    if(rs.length>0){\r\n      return this.json({status:0,errno:1,errmsg:'Email đã tồn tại!'});\r\n    }else{\r\n      return this.json({status:1,errno:0,errmsg:'Email có sẵn!'});\r\n    }\r\n  }\r\n  async passwordAction(){\r\n    this.assign(\"title\",\"Đổi mật khẩu\");\r\n    this.assign(\"tab\",\"userpass\");\r\n    this.initPage(\"password\");\r\n  }\r\n  async picAction(){\r\n    this.assign(\"title\",\"Ảnh đại diện\");\r\n    this.assign(\"tab\",\"userpic\");\r\n    this.initPage(\"pic\");\r\n  }\r\n}\r\n"
    ]
}