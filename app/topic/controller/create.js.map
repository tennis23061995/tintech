{
    "version": 3,
    "sources": [
        "..\\..\\..\\src\\topic\\controller\\create.js"
    ],
    "names": [
        "indexAction",
        "assign",
        "session",
        "uinfo",
        "think",
        "isEmpty",
        "model",
        "getUserPic",
        "name",
        "upic",
        "findAll",
        "parentid",
        "lstparentmenu",
        "navList",
        "menu",
        "i",
        "length",
        "parseInt",
        "id",
        "submenu",
        "submenusid",
        "j",
        "push",
        "parentmenu",
        "JSON",
        "parse",
        "submenus",
        "pic",
        "displayView",
        "redirect",
        "doaddAction",
        "mycreatetime",
        "datetime",
        "post",
        "updatetime",
        "data",
        "createtime",
        "findOne",
        "item",
        "itemurlrewrite",
        "urlrewrite",
        "itemname",
        "updateRecord",
        "rs",
        "success",
        "addRecord",
        "decrepoint",
        "author",
        "config",
        "points",
        "editAction",
        "myid",
        "get",
        "topicInfo",
        "savereplyAction",
        "marked",
        "require",
        "setOptions",
        "renderer",
        "Renderer",
        "gfm",
        "tables",
        "breaks",
        "pedantic",
        "sanitize",
        "smartLists",
        "smartypants",
        "text",
        "json",
        "status",
        "errno",
        "errmsg",
        "html",
        "comment",
        "isexist",
        "tid",
        "updata",
        "updateauthor",
        "updatepic",
        "fail",
        "add",
        "increpoint",
        "where",
        "increment",
        "replycount",
        "postlikeAction",
        "liker",
        "likers",
        "arr",
        "split",
        "n",
        "indexOf",
        "newlikers",
        "join",
        "m",
        "update",
        "like",
        "likeCount",
        "splice",
        "removereplyAction",
        "delete",
        "decrement",
        "removeitemAction",
        "uploadeditorAction",
        "IS_USE_OSS",
        "ALIOSS",
        "service",
        "alioss",
        "file",
        "extend",
        "upload",
        "filepath",
        "path",
        "newpath",
        "liFormatDate",
        "Date",
        "toLocaleDateString",
        "uploadPath",
        "UPLOAD_PATH",
        "mkdir",
        "basename",
        "renameSync"
    ],
    "mappings": "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",
    "file": "..\\..\\..\\src\\topic\\controller\\create.js",
    "sourcesContent": [
        "'use strict';\r\nimport fs from \"fs\";\r\nimport path from \"path\";\r\nimport Base from './base.js';\r\n\r\nexport default class extends Base {\r\n  /**\r\n   * index action\r\n   * @return {Promise} []\r\n   */\r\n  async indexAction(){\r\n       this.assign(\"title\",\"新建主题\");\r\n       let uinfo=await this.session('uInfo');\r\n       if(!think.isEmpty(uinfo)){\r\n           let upic=await this.model(\"topic\").getUserPic({name:uinfo.name});\r\n           var lstparentmenu=await this.model(\"topic\").findAll('item',{parentid:['IN', [0]]});\n           var navList={menu:[]};\n           for (var i = 0; i < lstparentmenu.length; i++) {\n             var submenu=await this.model(\"topic\").findAll('item',{parentid:['IN', [parseInt(lstparentmenu[i].id)]]});\n             var submenusid=[];\n             for (var j = 0; j < submenu.length; j++) {\n               submenusid.push(submenu[j].id);\n             }\n             navList.menu.push({parentmenu:JSON.parse(JSON.stringify(lstparentmenu[i])),submenus:JSON.parse(JSON.stringify(submenu)),submenusid:submenusid});\n           }\n           //let navList = await this.model(\"home\").findAll('item',{parentid:['IN', [0]]});\n           this.assign(\"navList\", navList);\r\n           this.assign('uinfo',uinfo);\r\n           this.assign('upic',upic.pic);\r\n           return this.displayView(\"create_index\");\r\n       }else {\r\n         return this.redirect('/login.html');\r\n       }\r\n  }\r\n\r\n  async doaddAction(){   //编辑或者新增主题\r\n      let mycreatetime=think.datetime(this.post('createtime'));\r\n      let updatetime=think.datetime(this.post('updatetime'));\r\n      let data=await this.post();\r\n      data.createtime=mycreatetime;\r\n      data.updatetime=updatetime;\r\n      var item=await this.model(\"topic\").findOne(\"item\",{id:data.item});\r\n      if(!think.isEmpty(item))\r\n      {\r\n        data.itemurlrewrite=item.urlrewrite;\r\n        data.itemname=item.itemname;\r\n      }\r\n      if(!think.isEmpty(this.post(\"id\"))){\r\n          let rs=await this.model(\"topic\").updateRecord(\"topic\",{id:data.id},data);\r\n          if(rs) return this.success();\r\n      }else{\r\n          let rs=await this.model(\"topic\").addRecord(\"topic\",data);\r\n          let points=await this.model(\"topic\").decrepoint({name:data.author},this.config('point.addtopic'));\r\n          if(rs) return this.success();\r\n      }\r\n  }\r\n\r\n  async editAction(){\r\n    this.assign(\"title\",\"编辑主题\");\r\n    let myid=this.get(\"tid\");\r\n    let uinfo=await this.session('uInfo');\r\n    if(!think.isEmpty(uinfo)){\r\n        let topicInfo=await this.model(\"topic\").findOne(\"topic\",{id:myid,author:uinfo.name});\r\n        if(!think.isEmpty(topicInfo)){\r\n          let upic=await this.model(\"topic\").getUserPic({name:uinfo.name});\r\n          this.assign('upic',upic.pic);\r\n          var lstparentmenu=await this.model(\"topic\").findAll('item',{parentid:['IN', [0]]});\r\n          var navList={menu:[]};\r\n          for (var i = 0; i < lstparentmenu.length; i++) {\r\n            var submenu=await this.model(\"topic\").findAll('item',{parentid:['IN', [parseInt(lstparentmenu[i].id)]]});\r\n            var submenusid=[];\r\n            for (var j = 0; j < submenu.length; j++) {\r\n              submenusid.push(submenu[j].id);\r\n            }\r\n            navList.menu.push({parentmenu:JSON.parse(JSON.stringify(lstparentmenu[i])),submenus:JSON.parse(JSON.stringify(submenu)),submenusid:submenusid});\r\n          }\r\n          //let navList = await this.model(\"home\").findAll('item',{parentid:['IN', [0]]});\r\n          this.assign(\"navList\", navList);\r\n          this.assign('uinfo',uinfo);\r\n          this.assign(\"topicInfo\",topicInfo)\r\n          return this.displayView(\"create_edit\");\r\n        }else {\r\n          return this.displayView(\"../common/error_404\");\r\n        }\r\n    }else {\r\n      return this.redirect('/login.html');\r\n    }\r\n  }\r\n\r\n  async savereplyAction(){\r\n    //编辑或者新增回复\r\n    let marked = require('marked');\r\n    marked.setOptions({\r\n        renderer: new marked.Renderer(),\r\n        gfm: true,\r\n        tables: true,\r\n        breaks: true,\r\n        pedantic: false,\r\n        sanitize: true,\r\n        smartLists: true,\r\n        smartypants: false\r\n    });\r\n      let mycreatetime=think.datetime(this.post('createtime'));\r\n      let data=await this.post();\r\n      data.createtime=mycreatetime;\r\n      if(data.text===''){\r\n        return this.json({status:0,errno:1,errmsg:'回复不能为空！'});\r\n      }else{\r\n        // 解析markdown\r\n        let html=marked(data.comment);\r\n        // data.comment=html;\r\n        if(!think.isEmpty(data.id)){\r\n          //编辑\r\n          let isexist=await this.model(\"topic\").findOne(\"topic_comment\",{id:data.id});\r\n          let tid=await this.model(\"topic\").findOne(\"topic\",{id:data.tid});\r\n          if(!think.isEmpty(isexist)&&!think.isEmpty(tid)){\r\n            //更新最后回复数据\r\n            let updata={\r\n              updatetime:mycreatetime,\r\n              updateauthor:data.author,\r\n              updatepic:data.pic\r\n            }\r\n            let updatetime=await this.model(\"topic\").updateRecord(\"topic\",{id:data.tid},updata);\r\n            //更新最后回复数据\r\n            // 更新回复\r\n            let rs=await this.model(\"topic\").updateRecord(\"topic_comment\",{id:data.id},data);\r\n            if(rs) return this.success();\r\n          }else{\r\n            return this.fail(\"该主题或回复不存在或已删除！\");\r\n          }\r\n        }else{\r\n          //更新最后回复数据\r\n          let updata={\r\n            updatetime:mycreatetime,\r\n            updateauthor:data.author,\r\n            updatepic:data.pic\r\n          }\r\n          let updatetime=await this.model(\"topic\").updateRecord(\"topic\",{id:data.tid},updata);\r\n          //更新最后回复数据\r\n          //增加\r\n          let rs=await this.model(\"topic_comment\").add(data);\r\n          // 增加积分\r\n          let points=await this.model(\"topic\").increpoint({name:data.author},this.config('point.addcomment'));\r\n          // 增加回复数\r\n          let replycount=await this.model(\"topic\").where({id:data.tid}).increment('replycount',1);\r\n          if(rs) return this.success();\r\n        }\r\n      }\r\n  }\r\n\r\n  async postlikeAction(){\r\n      let data=await this.post();\r\n      let liker=data.likers;\r\n      let myid=data.id;\r\n      if(!think.isEmpty(myid)){\r\n          let item=await this.model(\"topic\").findOne(\"topic_comment\",{id:myid});\r\n          let arr=(!item.likers)?[]:(item.likers).split(\",\");\r\n          let likers=arr||[];\r\n          let n=likers.indexOf(liker);\r\n          if(n<0){\r\n            likers.push(liker);\r\n            let newlikers=likers.join(\",\");\r\n            let m=likers.length;\r\n            let rs=await this.model(\"topic_comment\").where({id:myid}).update({like:m,likers:newlikers});\r\n            if(rs) return this.success({likeCount:m});\r\n          }else{\r\n            likers.splice(n,1);\r\n            let m=likers.length;\r\n            let newlikers=likers.join(\",\");\r\n            let rs=await this.model(\"topic_comment\").where({id:myid}).update({like:m,likers:newlikers});\r\n            if(rs) return this.success({likeCount:m});\r\n          }\r\n      }\r\n  }\r\n\r\n  async removereplyAction(){\r\n      let data=await this.post();\r\n      let myid=data.id;\r\n      if(!think.isEmpty(myid)){\r\n          let rs=await this.model(\"topic_comment\").where({id:myid}).delete();\r\n          // 减少回复数\r\n          let replycount=await this.model(\"topic\").where({id:data.tid}).decrement('replycount',1);\r\n          if(rs) return this.success();\r\n      }\r\n  }\r\n\r\n  async removeitemAction(){\r\n      let data=await this.post();\r\n      let myid=data.id;\r\n      if(!think.isEmpty(myid)){\r\n          let rs=await this.model(\"topic\").where({id:myid}).delete();\r\n          if(rs) return this.success();\r\n      }\r\n  }\r\n\r\n  //上传图片接口\r\n  async uploadeditorAction()\r\n  {\r\n      let IS_USE_OSS=think.config('OSS.on');\r\n      if(IS_USE_OSS){\r\n          //上传OSS图片接口\r\n          let ALIOSS = think.service(\"alioss\");\r\n          let alioss = new ALIOSS();\r\n          let file = think.extend({}, this.file('img'));\r\n          let rs=await alioss.upload(file);\r\n          if(rs){\r\n              return this.json(think.config('OSS.domain')+\"/\"+rs.name);\r\n          }else{\r\n              return this.json(\"上传失败！\");\r\n          }\r\n      }else{\r\n          //上传应用服务器图片接口\r\n          let file = think.extend({}, this.file('img'));\r\n          let filepath = file.path;\r\n          let newpath = liFormatDate(new Date().toLocaleDateString());\r\n          let uploadPath = think.UPLOAD_PATH + '/pics/' + newpath;\r\n          think.mkdir(uploadPath);\r\n          let basename = path.basename(filepath);\r\n          fs.renameSync(filepath, uploadPath + basename);\r\n          this.json(\"/static/upload/pics/\" + newpath + basename);\r\n      }\r\n  }\r\n\r\n}\r\n"
    ]
}